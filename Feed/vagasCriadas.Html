<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <link rel="stylesheet" href="../Home/style.css" />
    <link rel="shortcut icon" href="../assets/logo.png" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <link rel="stylesheet" href="../Home/home.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="../js/logout.js"></script>
    <title>Vagas Criadas</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f4;
      }

      header {
        display: flex;
        justify-content: space-between;
        margin: 30px;
        align-items: center;
      }

      .titulo-header {
        display: flex;
        align-items: flex-end;
        gap: 40px;
      }

      .titulo-header h4 {
        color: #5f4589;
        font-family: Bebas Neue;
        font-size: 30px;
        font-style: normal;
        font-weight: 400;
        line-height: normal;
      }

      .titulo-header img {
        width: 100px;
      }

      .vaga {
        background-color: white;
        border: 1px solid #ddd;
        padding: 15px;
        margin: 10px;
        border-radius: 5px;
      }

      .vaga h3 {
        margin: 0;
      }

      .vaga p {
        margin: 5px 0;
      }

      .vaga .detalhes {
        font-size: 14px;
        color: #555;
      }
    
      .vaga .habilidade {
        font-weight: bold;
      }

      .no-vagas {
        text-align: center;
        color: red;
      }

      .back-button {
        font-size: 20px;
        background: none;
        border: none;
        cursor: pointer;
        font-weight: bold;
      }

      .back-button:hover {
        color: #5f4589;
      }
    </style>
  </head>
  <body>

    <header class="container-fluid">
      <img src="../assets/logo.png" alt="Logo" class="logo-header" />
      <button class="back-button" onclick="window.history.back()">←</button>
      <h1>Aqui estão as Vagas criadas por você</h1>
      <div class="dropdown">
        <button class="login-btn-header dropdown-btn">Minha Conta</button>
        <div class="dropdown-content">
          <a href="../EditProfile/edit_profile.html">Editar Dados</a>
          <a href="../Feed/feed_freelancers.html">Freelancers</a>
          <a href="../Feed/feed_vagas.html">Mural de serviços</a>
          <a href="#" onclick="logout()">Sair da Conta</a>
        </div>
      </div>
    </header>

    <div id="vagaContainer"  style="grid-template-columns: 1fr 1fr;display: grid;"></div>

    <script>
      async function carregarVagas() {
        const vagaContainer = document.getElementById("vagaContainer");
        const userEmail = localStorage.getItem("userEmail"); // Obtém o e-mail do usuário logado
        const userId = localStorage.getItem('userid');

        if (!userEmail || !userId) {
          alert("Usuário não está logado");
          return;
        }

        try {
          const token = localStorage.getItem("token");
          if (!token) {
            alert("Usuário não autenticado.");
            return;
          }

          const response = await fetch("http://localhost:3000/vagas/Todasvagas", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              authorization: token,
            },
          });
          if (!response.ok) {
            throw new Error("Erro ao carregar as vagas");
          }

          const vagas = await response.json();
          if (!Array.isArray(vagas)) {
            throw new Error("Resposta inesperada do servidor");
          }

          const vagasDoUsuario = vagas.filter(vaga => vaga.criador === userId);

          if (vagasDoUsuario.length > 0) {
            vagaContainer.innerHTML = "";
            vagasDoUsuario.forEach(vaga => {
              const vagaElement = document.createElement("div");
              vagaElement.classList.add("vaga");
              vagaElement.innerHTML = `
                <h3>${vaga.AreaDeDominio}</h3>
                <p>${vaga.descricao}</p>
                <p class="detalhes">Criada por: ${vaga.criador}</p>
                <button class="PropostasRecebidas" onclick="fazerProposta('${vaga._id}')">
                  Propostas Recebidas
                </button>
                <button class="PropostasRecebidas" onclick="ExcluirVaga('${vaga._id}')">
                 Excluir Vaga
                </button>
              `;
              vagaContainer.appendChild(vagaElement);
            });
          } else {
            vagaContainer.innerHTML = 
  '<div class="btn-cadastrar col-md-6 col-sm-12 order-2 order-md-1 mt-3 d-flex align-items-center justify-content-center" '
  +'style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">' +
  '<a href="../Cadastro/cadastro_vagas.html">' +
  '<button class="cadastrar fs-1">olá Contratante você ainda criou uma vaga, Crie sua Vaga aqui</button>' +
  '</a>' +
  '</div>';

          }
        } catch (error) {
          console.error("Erro:", error);
          vagaContainer.innerHTML = '<p class="error">Houve um problema ao carregar as vagas. Por favor, tente novamente mais tarde.</p>';
        }
      }

      function fazerProposta(id) {
        localStorage.setItem("vagaId", id);
        console.log("ID da vaga armazenado:", id);
        window.location.href = "../Feed/PropostasRecebidas.html"; // Redireciona para a página de propostas
      }
      async function ExcluirVaga(id) {
        const confirmacao = confirm(`Tem certeza que deseja excluir a vaga ?`);
        if (confirmacao) {
       
       
        try {
            const token = localStorage.getItem("token");  // Obter o token do localStorage
            const response = await fetch(`http://localhost:3000/vagas/delete/${id}`, {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json",
                    authorization: token,
                },
            });

            if (!response.ok) {
                throw new Error("Erro ao excluir a vaga");
            }

            alert("Vaga excluída com sucesso!");
            carregarVagas(); // Certifique-se de que essa função está definida
        } catch (error) {
            console.error("Erro ao excluir vaga:", error);
            alert("Erro ao excluir vaga. Tente novamente.");
        }
    
}
      }
    
      carregarVagas();
    </script>
  </body>
</html>
